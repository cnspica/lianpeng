(function(){var b;$(".search").submit(function(){var w=$(this).find(".query").val();var v=$(this).attr("action")+w;if(b){b.navigate(v,{trigger:true})}else{window.location.href=v}return false});$("#feedback .confirm").click(function(){if($(this).hasClass("disabled")){return false}$(this).addClass("disabled");var w=$("#feedback textarea").val();var v={text:w};v=JSON.stringify(v);$.ajax({url:"/api/v1/feedback/",data:v,type:"POST",contentType:"application/json",dataType:"application/json"}).complete(function(){$("#feedback textarea").hide();$("#feedback .success").show()});return false});$("#feedback").on("hidden",function(){$("#feedback textarea").val("");$("#feedback .confirm").removeClass("disabled");$("#feedback textarea").show();$("#feedback .success").hide()});F={fetch_title:function(v,w){$.post("/harvest/pageinfo/",{url:v},w)},url_domain:function(w){var v=document.getElementById("url-template");v.href=w;var x=v.hostname;if(v.port&&v.port!=80){x+=":"+v.port}return x},form2json:function(w){var x={};var v=$(w).serializeArray();$.each(v,function(){if(x[this.name]!==undefined){if(!x[this.name].push){x[this.name]=[x[this.name]]}x[this.name].push(this.value||"")}else{x[this.name]=this.value||""}});return x},show_paginator:function(v,x,y){var w=v;if(w.collection.total_count>w.collection.paginationConfig.ipp){w.$(".paginator").pagination({total_pages:Math.ceil(w.collection.total_count/w.collection.paginationConfig.ipp),current_page:w.collection.currentPage,display_max:x,callback:function(z,A){y();w.collection.loadPage(A)}}).show()}else{w.$(".paginator").hide()}}};$.fn.spin=function(v){this.each(function(){var x=$(this),w=x.data();if(w.spinner){w.spinner.stop();delete w.spinner}if(v!==false){w.spinner=new Spinner($.extend({color:x.css("color")},v)).spin(this)}});return this};var o="/api/v1/user/"+USER_ID;var m=Backbone.Model.extend({urlRoot:"/api/v1/bookmark/"});var a=Backbone.Collection.extend({parse:function(v){this.total_count=v.meta.total_count;return v.objects}});var c=Backbone.Model.extend({urlRoot:"/api/v1/list/"});var k=c.extend({});var i=a.extend({model:c,initialize:function(){Backbone.Pagination.enable(this,{page_attr:"offset",ipp:100,ipp_attr:"limit"})},baseUrl:"/api/v1/list/"});var e=Backbone.View.extend({events:{"click .list-name":"redirect"},initialize:function(){var v=this;this.model.bind("destroy",this.delete_model,this);this.model.bind("change",this.change_name,this);this.$el.droppable({accept:".bookmark-entry-box",tolerance:"pointer",drop:_.bind(function(y,z){var x=$(y.target);var w=$(z.draggable).data("id");var A=$(z.draggable).data("list-id");v.trigger("dropped",A,w,v.model);$(z.draggable).remove()},this),over:_.bind(function(x,y){var w=$(x.target);if(w.hasClass("active")){w.addClass("source")}else{w.addClass("active")}},this),out:_.bind(function(x,y){var w=$(x.target);if(!w.hasClass("source")){w.removeClass("active")}},this)})},delete_model:function(){this.remove();$("#all-list .list-name").click()},redirect:function(){var v=USER_NAME+"/list/"+this.model.id;if(Backbone.history.fragment==v){Backbone.history.fragment=null}Backbone.history.navigate(v,true)},render:function(){var x=this.model;var w=$("#list-bookmarks-tmpl").html();var v=_.template(w,{list:x.toJSON()});$("#bookmarks").html(v);$("#bookmarks").spin();this.bookmarks=new n({list:this.model});this.bookmarks.bind("reset",this.stop_spin,this);this.model.bookmarks=this.bookmarks;this.bookmarks_view=new s({collection:this.bookmarks,el:"#bookmarks #list-bookmarks-"+this.model.id+" .bookmarks",list:this.model});this.bookmarks.fetch();this.list_setting_view=new g({el:"#bookmarks #list-bookmarks-"+this.model.id+" .list-header",model:this.model});$("#lists li").removeClass("active");this.$el.addClass("active")},stop_spin:function(){$("#bookmarks").spin(false)},change_name:function(){this.$(".list-name .name-text").text(this.model.get("name"))}});var u=e.extend({initialize:function(){}});var d=e.extend({render:function(){e.prototype.render.call(this);$(".add-bookmark-form-box").hide();$(".list-setting-box").hide()}});var j=d.extend({});var g=Backbone.View.extend({events:{"click .delete-list":"delete_list","click .list-edit-modal .save":"update","submit .list-edit-modal form":"update","click .edit-list":"edit"},change_name:function(){this.$(".list-name").text(this.model.get("name"))},initialize:function(){this.model.bind("change",this.change_name,this)},delete_list:function(){this.model.destroy()},edit:function(){this.$(".list-edit-modal").modal()},update:function(){this.$(".list-edit-modal").modal("hide");var v=this.$(".list-edit-modal form");var w=F.form2json(v);if(!("public" in w)){w["public"]=false}this.model.save(w);return false}});var r=Backbone.View.extend({el:"#lists",events:{"click .new-list-button":"show_add_form","submit .new-list-form":"add"},views:{},current_list:null,initialize:function(){var v=this;this.collection=new i();this.collection.bind("add",this.append_new_list,this);this.collection.bind("reset",this.render,this);this.collection.fetch();this.bookmarks=this.options.bookmarks;this.$(".lists-ul").sortable({revert:true,start:function(w,x){},stop:function(w,y){var z=$(y.item).data("id");var x=v.collection.get(z);x.save({position:y.item.index()})}})},render_current_list_view:function(v){this.current_list_view=v;this.current_list_view.render()},render:function(){var v=this;this.$("ul.lists-ul").html("");$.each(this.collection.models,function(w,x){v.append_new_list(x)});if(!this.$(".jquery-bootstrap-pagination").html()){F.show_paginator(v,4,function(){})}this.$(".jquery-bootstrap-pagination").addClass("pagination-mini");this.resize_height()},resize_height:function(){var w=$(".user-lists").height();var v=q-290;if(v<w){w=v}$(".user-lists").css("height",w)},append_new_list:function(z){var y=$("#list-tmpl").html();var w=_.template(y,{lists:[z.toJSON()]});var A=this.$("ul.lists-ul");var x=z.get("kind");if(x!=2){A=this.$(".sys-lists .nav")}A.append(w);var v=this;var B=new e({model:z,el:"#list-"+z.id});this.views[z.id]=B;B.bind("seleted",this.list_selected,this);B.bind("dropped",this.list_dropped,this);z.bind("destroy",this.render_all_list,this)},show_add_form:function(){$(".new-list-button").hide();$(".new-list-form").show();$(".new-list-form").find("input.list-name").focus()},list_dropped:function(z,v,y){if(typeof(z)!="number"){var x=this.current_list_view.model}else{var x=this.collection.get(z)}var w=x.bookmarks.get(v);w.save({list:y.url()})},list_selected:function(v){},add:function(x){var v=$(x.currentTarget);var w=F.form2json(v);w.user=o;this.collection.create(w,{wait:true});$(".new-list-button").show();$(".new-list-form").hide();v.find("input.list-name").val("");return false}});var n=a.extend({model:m,list:null,initialize:function(v){if(v&&v.list){this.list=v.list}Backbone.Pagination.enable(this,{page_attr:"offset",ipp:20,ipp_attr:"limit"})},baseUrl:function(){if(this.list){if(typeof(this.list.id)=="number"){return this.list.url()+"/bookmarks/"}else{var v="";if(this.list.id=="search"){v="?q="+this.list.get("query")}else{if(this.list.id=="tag"){v="?tag="+this.list.get("tag")}}return"/api/v1/bookmark/"+v}}else{return"/api/v1/bookmark/"}}});var f=Backbone.View.extend({initialize:function(){this.$el=$("#bookmark-"+this.model.id);this.events={"click .edit-action":"edit","click .share-action":"share","click .shares .douban":"share_douban",hover:"show_actions","hover .move":"enable_drag","mouseleave .move":"disable_drag","click .remove-action":"remove"};this.list=this.options.list;this.listenTo(this.model,"destroy",this.remove_bookmark_html);this.listenTo(this.model,"change",this.append_bookmark_html)},share:function(v){$(v.currentTarget).dropdown("toggle")},share_douban:function(){var y=this.model.get("note");var C=this.model.get("title");var w=this.model.get("url");var B=document,A=encodeURIComponent,z="http://www.douban.com/recommend/?url="+A(w)+"&title="+A(C)+"&sel="+A(y)+"&v=1",v=function(){if(!window.open(z,"douban","toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330")){location.href=z+"&r=1"}};if(/Firefox/.test(navigator.userAgent)){setTimeout(v,0)}else{v()}},enable_drag:function(){this.$el.draggable({helper:"clone",});this.$el.draggable("enable")},disable_drag:function(){this.$el.draggable("disable")},show_actions:function(){this.$(".move").toggle();this.$(".actions").toggle()},remove_bookmark_html:function(){this.$el.remove()},remove:function(){this.model.destroy()},append_bookmark_html:function(x){var w=$("#bookmarks-tmpl").html();var x=this.model;var v=_.template(w,{bookmarks:[x.toJSON()],list:this.list});this.$el.html($(v).html())},edit:function(){var v=this;var x=$("#bookmark-form-tmpl").html();var w=_.template(x,{bookmark:v.model.toJSON()});this.$(".bookmark-title-box").hide();this.$(".edit-bookmark-box").html(w);v.$(".edit-bookmark-box form").submit(function(y){v.model.save(F.form2json(this));v.$(".bookmark-title-box").show();return false});v.$(".edit-bookmark-box form .cancel").click(function(){v.$(".edit-bookmark-box").hide();v.$(".bookmark-title-box").show()})}});var s=Backbone.View.extend({events:{"click .tag":"list_by_tag","submit .add-bookmark-form":"add_bookmark"},list_by_tag:function(w){var v=$(w.currentTarget).text();b.navigate(USER_NAME+"/tag/"+v,{trigger:true})},initialize:function(){var v=this;v.listenTo(v.collection,"add",function(w){v.create_bookmark_view(w,true)});v.listenTo(v.collection,"reset",v.create_bookmarks_views);this.list=this.options.list},create_bookmarks_views:function(x){var w=x.models;var v=this;v.render();v.render_pagination();$.each(w,function(y,z){v.create_bookmark_view(z)})},create_bookmark_view:function(w,v){if(v){this.append_bookmark_html(w)}var x=new f({model:w,list:this.list})},add_bookmark:function(x){var w=$(x.currentTarget).find(".url").val();$(x.currentTarget).spin();$(x.currentTarget).find("input").attr("disabled","on");var v=this;F.fetch_title(w,function(D){$(x.currentTarget).spin(false);D=$.parseJSON(D);if(D){var C=F.url_domain(w);var B={url:w,user:o,title:D.title,domain:C,note:D.description};var A=$("#bookmark-form-tmpl").html();var z=_.template(A,{bookmark:B});v.$(".confirm-add-bookmark").html(z).show();v.$(".confirm-add-bookmark .existed-bookmark .spinner").spin({length:0,radius:6,width:2});var y=new n();y.bind("reset",function(G){v.$(".confirm-add-bookmark .existed-bookmark .spinner").spin(false);if(G.total_count>0){var E=G.models[0];v.$(".confirm-add-bookmark .existed-bookmark").addClass("alert");v.$(".confirm-add-bookmark .existed-bookmark .text").show();v.$(".confirm-add-bookmark .existed-bookmark .edit").click(function(){if(!v.collection.get(E.id)){v.collection.push(E)}v.$(".confirm-add-bookmark .existed-bookmark .edit").attr("href","#bookmark-"+E.id);v.$(".list #bookmark-"+E.id+" .bookmark-title-box .actions .edit-action").trigger("click");v.recover_submit_form(x.currentTarget)})}else{v.$(".confirm-add-bookmark .existed-bookmark").hide()}});y.fetch({url:y.url()+"&url="+w});v.$(".confirm-add-bookmark form").submit(function(){var E=F.form2json(this);if(v.list.id!="all"){E.list=v.list.url()}v.collection.create(E,{wait:true,success:function(G){}});v.recover_submit_form(x.currentTarget);return false});v.$(".confirm-add-bookmark form .cancel").click(function(){v.recover_submit_form(x.currentTarget)})}});return false},recover_submit_form:function(v){$(".confirm-add-bookmark").hide();$(v).find("input").removeAttr("disabled");$(v).find("input.url").val("")},append_bookmark_html:function(x){var w=$("#bookmarks-tmpl").html();var v=_.template(w,{bookmarks:[x.toJSON()],list:this.list.toJSON()});this.$(".no-bookmarks").hide();this.$(".list").prepend(v)},render_pagination:function(){if(!this.$(".jquery-bootstrap-pagination").html()){var v=this;F.show_paginator(v,8,function(){$(v.$(".list").children()[0]).spin()})}},render:function(){var v=this;if(this.collection.size()>0){var x=$("#bookmarks-tmpl").html();var w=_.template(x,{bookmarks:this.collection.toJSON(),list:v.list.toJSON()});this.$(".list").html(w)}else{this.$(".list .no-bookmarks").show()}}});var l=new r();var h=new c({id:"all"});var t=new u({model:h,el:"#all-list",fake_list:true});var p=Backbone.Router.extend({routes:{"":"index",":username/list/all":"index",":username/list/:id":"list",":username/tag/:tag":"tag",":username/search/:query":"search"},index:function(v){l.render_current_list_view(t)},list:function(z,y){var w=l.views[y];var x=y;if(w){w.render()}else{var v=new c({id:x});var w=new e({model:v});v.bind("change",function(A){w.render()});v.fetch()}},search:function(y,w){var v=new c({id:"search",query:w,name:TEXTS.search_title+w});var x=new d({model:v,el:"#no-such-dom",fake_list:true});l.render_current_list_view(x)},tag:function(y,v){var w=new c({id:"tag",tag:v,name:TEXTS.tag_title+v});var x=new j({model:w,el:"#no-such-dom",fake_list:true});l.render_current_list_view(x)}});var b=new p();var q=$(window).height();$("#bookmarks").css("min-height",q);$("#lists").css("min-height",q);sidebarwidth=$(".sidebar-width").css("width");bodypaddingtop=$(".navbar-fixed-top").css("height");$(".sidebar-nav-fixed").css("width",sidebarwidth);contentmargin=parseInt(sidebarwidth);$(".span-fixed-sidebar").css("marginLeft",contentmargin);$(".span-fixed-sidebar").css("paddingLeft",60);Backbone.history.start({pushState:true})}).call(this);