(function(){var a=Backbone.Collection.extend({parse:function(z){this.total_count=z.meta.total_count;return z.objects}});var g=function(D){var z=o.collection.toJSON();var E;for(var C=0;C<z.length;C++){var A=false;var B=z[C].name;if(z[C].kind==3){B+=" - "+z[C].user_name}if(D&&D==z[C].resource_uri){A=true}E+='<option value="'+z[C].resource_uri;if(A){E+='" selected="on'}E+='" >'+B+"</option>"}return E};var q=Backbone.Model.extend({urlRoot:"/api/v1/bookmark/"});var p=a.extend({model:q,list:null,initialize:function(z){if(z&&z.list){this.list=z.list}Backbone.Pagination.enable(this,{page_attr:"offset",ipp:20,ipp_attr:"limit"})},baseUrl:function(){if(this.list){if(typeof(this.list.id)=="number"){return this.list.url()+"/bookmarks/"}else{var z="";if(this.list.id=="search"){z="?q="+this.list.get("query")}else{if(this.list.id=="tag"){z="?tag="+this.list.get("tag")}else{if(this.list.id=="feed"){z="?feed=t"}}}return"/api/v1/bookmark/"+z}}else{return"/api/v1/bookmark/"}}});var f=Backbone.View.extend({initialize:function(){this.$el=$("#bookmark-"+this.model.id);this.events={"click .edit-action":"edit","click .share-action":"share","click .preview-action":"preview","click .save-action":"collect","click .shares .douban":"share_douban","click .shares .weibo":"share_weibo","click .comment-action":"show_comment_box","click #preview-box .close-preview":"close_preview","click #preview-box .read-mode":"read_mode",hover:"show_actions","hover .move":"enable_drag","mouseleave .move":"disable_drag","click .remove-action":"remove"};this.list=this.options.list;this.listenTo(this.model,"destroy",this.remove_bookmark_html);this.listenTo(this.model,"change",this.append_bookmark_html);this.comments_view=new w({el:"#bookmark-"+this.model.id+" .comments-box",bookmark:this.model});this.$(".actions li").tooltip()},show_comment_box:function(){if(this.list.can_comment()){this.$(".comments-box").toggle();if(!this.comments_view.loaded){this.comments_view.fetch()}}},collect:function(){this.trigger("new_bookmark",this.model.toJSON(),"","#bookmark-"+this.model.id+" .edit-bookmark-box")},share:function(z){$(z.currentTarget).dropdown("toggle")},preview:function(z){this.$el.append($("#preview-box"));$("#preview-box").show();$("#preview-box").spin();this.read_mode()},close_preview:function(){$("#preview-box").hide();$("#preview-box #read-box").hide()},read_mode:function(){var z="http://www.diffbot.com/api/article?token=b5d5504cbe0e360e30b70152b1a38ecc&html=true&url="+encodeURIComponent(this.model.get("url"));$.ajax({url:z,dataType:"jsonp"}).done(function(B){$("#preview-box").spin(false);$("#preview-box #read-box").show();$("#preview-box #read-box .title").text(B.title);$("#preview-box #read-box .url").text(B.url);$("#preview-box #read-box .external-link").attr("href",B.url);var A=$(B.html);A.find("a").attr("target","_blank");$("#preview-box #read-box .article").html(A)})},share_douban:function(){var B=this.model.get("note");var G=this.model.get("title");var A=this.model.get("url");var E=document,D=encodeURIComponent,C="http://www.douban.com/recommend/?url="+D(A)+"&title="+D(G)+"&sel="+D(B)+"&v=1",z=function(){if(!window.open(C,"douban","toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330")){location.href=C+"&r=1"}};if(/Firefox/.test(navigator.userAgent)){setTimeout(z,0)}else{z()}},share_weibo:function(){var C=this.model.get("note");var H=this.model.get("title");var B=this.model.get("url");var G={url:B,type:"6",count:"",appkey:"4018245563",title:H,pic:"",ralateUid:"3358911402",language:"zh_cn",rnd:new Date().valueOf()};var A=[];for(var E in G){A.push(E+"="+encodeURIComponent(G[E]||""))}var D="http://service.weibo.com/share/share.php?"+A.join("&");var z=function(){if(!window.open(D,"douban","toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330")){location.href=D+"&r=1"}};if(/Firefox/.test(navigator.userAgent)){setTimeout(z,0)}else{z()}},enable_drag:function(){this.$el.draggable({helper:"clone",});this.$el.draggable("enable")},disable_drag:function(){this.$el.draggable("disable")},show_actions:function(){this.$(".move").toggle();this.$(".actions").toggle()},remove_bookmark_html:function(){this.$el.remove()},remove:function(){this.model.destroy()},append_bookmark_html:function(B){var A=$("#bookmarks-tmpl").html();var B=this.model;var z=_.template(A,{bookmarks:[B.toJSON()],list:this.list.toJSON(),can_edit:this.list.can_edit()});this.$el.html($(z).html())},edit:function(){var z=this;var B=$("#bookmark-form-tmpl").html();var A=_.template(B,{bookmark:z.model.toJSON(),list:this.list.toJSON()});this.$(".edit-bookmark-box").html(A);this.$(".edit-bookmark-box .existed-bookmark").hide();this.$(".edit-bookmark-box").show();var C=g(this.model.get("list"));z.$(".edit-bookmark-box").find("form #list");z.$(".edit-bookmark-box").find("form #list").append(C);z.$(".edit-bookmark-box form").submit(function(D){z.model.save(F.form2json(this));return false});z.$(".edit-bookmark-box form .cancel").click(function(){z.$(".edit-bookmark-box").hide()})}});var v=Backbone.View.extend({events:{"click .tag":"list_by_tag","submit .add-bookmark-form":"add_bookmark"},list_by_tag:function(A){var z=$(A.currentTarget).text();router.navigate(USER_NAME+"/tag/"+z,{trigger:true})},initialize:function(){var z=this;z.listenTo(z.collection,"add",function(A){z.create_bookmark_view(A,true)});z.listenTo(z.collection,"reset",z.create_bookmarks_views);this.list=this.options.list},create_bookmarks_views:function(B){var A=B.models;var z=this;z.render();z.render_pagination();$.each(A,function(C,D){z.create_bookmark_view(D)})},create_bookmark_view:function(A,z){if(z){this.append_bookmark_html(A)}var B=new f({model:A,list:this.list});this.listenTo(B,"new_bookmark",this.show_add_bookmark_form)},add_bookmark:function(B){var A=$(B.currentTarget).find(".url").val();A=$.trim(A);if(A.indexOf("http://")>=0||A.indexOf("https://")>=0){}else{noty({text:"请输入正确的链接",type:"warning",timeout:1000});return false}$(B.currentTarget).spin();$(B.currentTarget).find("input").attr("disabled","on");var z=this;F.fetch_title(A,function(D){$(B.currentTarget).spin(false);D=$.parseJSON(D);if(D){var C=F.url_domain(A);D.url=A;D.domain=C;D.tags="";z.show_add_bookmark_form(D,B.currentTarget)}});return false},show_add_bookmark_form:function(D,C,G){var z={url:D.url,user:USER_URL,title:D.title,domain:D.domain,note:D.note,tags:D.tags};var A=D.url;var J=this;if(!G){G=".confirm-add-bookmark"}var I=$("#bookmark-form-tmpl").html();var E=_.template(I,{bookmark:z,list:this.list.toJSON()});J.$(G).html(E).show();var B=g(J.list.url());J.$(G).find("form #list").append(B);J.$(G+" .existed-bookmark .spinner").spin({length:0,radius:6,width:2});var H=new p();H.bind("reset",function(L){J.$(G+" .existed-bookmark .spinner").spin(false);if(L.total_count>0){var K=L.models[0];J.$(G+" .existed-bookmark").addClass("alert");J.$(G+" .existed-bookmark .text").show();J.$(G+" .existed-bookmark .edit").click(function(){if(!J.collection.get(K.id)){J.collection.push(K)}J.$(G+" .existed-bookmark .edit").attr("href","#bookmark-"+K.id);J.$(".list #bookmark-"+K.id+" .bookmark-title-box .actions .edit-action").trigger("click");J.recover_submit_form(G,C)})}else{J.$(G+" .existed-bookmark").hide()}});H.fetch({url:H.url()+"&url="+encodeURIComponent(A)});J.$(G+" form").submit(function(){var K=F.form2json(this);J.collection.create(K,{wait:true,success:function(L){}});J.recover_submit_form(G,C);return false});J.$(G+" form .cancel").click(function(){J.recover_submit_form(G,C)})},recover_submit_form:function(A,z){$(A).hide();$(z).find("input").removeAttr("disabled");$(z).find("input.url").val("")},append_bookmark_html:function(B){if(this.list.id=="feed"){return false}var A=$("#bookmarks-tmpl").html();var z=_.template(A,{bookmarks:[B.toJSON()],list:this.list.toJSON(),can_edit:this.list.can_edit()});this.$(".no-bookmarks").hide();this.$(".list").prepend(z)},render_pagination:function(){if(!this.$(".jquery-bootstrap-pagination").html()){var z=this;F.show_paginator(z,8,function(){$(z.$(".list").children()[0]).spin()})}},render:function(){var z=this;if(this.collection.size()>0){var B=$("#bookmarks-tmpl").html();var A=_.template(B,{bookmarks:this.collection.toJSON(),list:z.list.toJSON(),can_edit:this.list.can_edit()});this.$(".list").html(A)}else{this.$(".list .no-bookmarks").show()}}});var u=Backbone.Model.extend({urlRoot:"/api/v1/comment/"});var n=a.extend({model:u,url:"/api/v1/comment/"});var l=Backbone.View.extend({events:{hover:"show_actions","click .remove":"delete_comment"},delete_comment:function(z){this.model.destroy();this.remove()},show_actions:function(z){this.$(".comment-actions").toggle()}});var w=Backbone.View.extend({events:{"submit form":"comment","click .more":"load_more"},participants:[],loaded:false,current_page:0,count:0,initialize:function(){this.bookmark=this.options.bookmark;this.collection=new n();this.collection.bind("reset",this.render,this);this.collection.bind("add",this.add_comment,this)},fetch:function(){this.collection.fetch({url:this.collection.url+"?limit=10&object_pk="+this.bookmark.id})},load_more:function(){if(this.$(".more").hasClass("disabled")){return}var A=this;var z=10;var B=this.current_page*10;this.collection.fetch({url:this.collection.url+"?limit="+z+"&offset="+B+"&object_pk="+this.bookmark.id,complete:function(){if(A.count==A.collection.total_count){A.$(".more").addClass("disabled").text("已经没有更多的评论")}}})},comment:function(B){var z=$(B.currentTarget).find("[type='submit']");if(z.hasClass("disabled")){return false}z.addClass("disabled");var A=F.form2json(B.currentTarget);if(!$.trim(A.comment)){noty({text:"您必须填写评论内容",type:"warning",timeout:1000});return false}this.collection.create(A,{wait:true,success:function(C){z.removeClass("disabled");$(B.currentTarget).find("textarea").val("")},});return false},render:function(){var z=this;this.$el.show();this.participants=[];$.each(this.collection.models,function(A,B){z.add_comment(B)});$("textarea").atwho({at:"@",data:this.participants,});this.loaded=true;this.current_page+=1;this.count+=this.collection.size();if(this.collection.total_count<10){this.$(".more-box").hide()}if(this.count==0){this.$(".comments").hide()}},add_comment:function(E){var B=$("#comment-tmpl").html();var C=E.toJSON();var A=_.template(B,{comments:[C],current_user:USER_URL});var D=$(A);this.$(".comments").append(D).show();var z=new l({model:E,el:D});if(this.participants.indexOf(C.user_name)<0){this.participants.push(C.user_name)}}});var s;var o;var b=Backbone.Model.extend({urlRoot:"/api/v1/list/",can_edit:function(){var z=false;if(this.get("user")==USER_URL){z=true}var B=this.get("perms");if(B){for(var A=0;A<B.length;A++){if("can_edit"==B[A]){z=true;break}}}return z},can_comment:function(){return true}});var m=b.extend({});var j=a.extend({model:b,initialize:function(){Backbone.Pagination.enable(this,{page_attr:"offset",ipp:100,ipp_attr:"limit"})},baseUrl:"/api/v1/list/"});var h=j.extend({baseUrl:"/api/v1/list/share/"});var y=Backbone.Model.extend({urlRoot:"/api/v1/listinvitation/"});var r=a.extend({model:y,url:"/api/v1/listinvitation/"});var d=Backbone.View.extend({events:{"click .list-name":"redirect"},initialize:function(){var z=this;this.model.bind("destroy",this.delete_model,this);this.model.bind("change",this.change_name,this);this.$el.droppable({accept:".bookmark-entry-box",tolerance:"pointer",drop:_.bind(function(C,D){var B=$(C.target);var A=$(D.draggable).data("id");var E=$(D.draggable).data("list-id");z.trigger("dropped",E,A,z.model);$(D.draggable).remove()},this),over:_.bind(function(B,C){var A=$(B.target);if(A.hasClass("active")){A.addClass("source")}else{A.addClass("active")}},this),out:_.bind(function(B,C){var A=$(B.target);if(!A.hasClass("source")){A.removeClass("active")}},this)})},delete_model:function(){this.remove();$("#all-list .list-name").click()},redirect:function(){var z=USER_NAME+"/list/"+this.model.id;if(Backbone.history.fragment==z){Backbone.history.fragment=null}Backbone.history.navigate(z,true)},render:function(){var B=this.model;var A=$("#list-bookmarks-tmpl").html();var z=_.template(A,{list:B.toJSON(),can_edit:B.can_edit()});$("#bookmarks").html(z);$("#bookmarks").spin();this.bookmarks=new p({list:this.model});this.bookmarks.bind("reset",this.stop_spin,this);this.model.bookmarks=this.bookmarks;this.bookmarks_view=new v({collection:this.bookmarks,el:"#bookmarks #list-bookmarks-"+this.model.id+" .bookmarks",list:this.model});this.bookmarks.fetch();this.list_setting_view=new e({el:"#bookmarks #list-bookmarks-"+this.model.id+" .list-header",model:this.model});$("#lists li").removeClass("active");this.$el.addClass("active")},stop_spin:function(){$("#bookmarks").spin(false)},change_name:function(){this.$(".list-name .name-text").text(this.model.get("name"))}});var x=d.extend({initialize:function(){}});var c=d.extend({render:function(){d.prototype.render.call(this);$(".add-bookmark-form-box").hide();$(".list-setting-box").hide()}});var i=c.extend({});var k=Backbone.View.extend({events:{"change select.permission":"change_invitee_permission","click .delete":"remove_invitee_permission",},initialize:function(){},remove_invitee_permission:function(z){this.model.destroy();this.remove()},change_invitee_permission:function(B){var z=$(B.currentTarget);var A=z.val();this.model.save({permission:A})}});var e=Backbone.View.extend({events:{"click .delete-list":"delete_list","click .invite-list":"show_invite","click .list-edit-modal .save":"update","click .invite-list-modal .invite":"invite","submit .invite-list-modal form":"invite","submit .list-edit-modal form":"update","click .edit-list":"edit"},initialize:function(){this.model.bind("change",this.render,this);this.render();this.list_invitations=new r();this.list_invitations.bind("reset",this.render_invitees,this);this.list_invitations.bind("add",this.append_invitee,this)},render:function(){var A=$("#list-header-tmpl").html();var z=_.template(A,{list:this.model.toJSON(),can_edit:this.model.can_edit()});this.$el.html(z)},delete_list:function(){var z=confirm("确认删除？");if(z){this.model.destroy()}},render_invitees:function(A){this.$(".invite-list-modal #invitee-list").html("");for(var z=0;z<A.models.length;z++){this.append_invitee(A.models[z])}},append_invitee:function(C){var A=$("#invitee-list-tmpl").html();var z=$(_.template(A,{invitees:[C.toJSON()]}));this.$(".invite-list-modal #invitee-list").append(z);var B=new k({model:C,el:z})},show_invite:function(){this.list_invitations.fetch({url:this.list_invitations.url+"?list="+this.model.id});this.$(".invite-list-modal").modal()},invite:function(){var B=this.$(".invite-list-modal form");var C=F.form2json(B);var z=C.invitee;var E=z.split(",");for(var A=0;A<E.length;A++){var D=$.trim(E[A]);if(D){C.invitee=D;this.list_invitations.create(C,{wait:true,success:function(){B.find(".invited").hide();B.find('input[name="invitee"]').val("")},error:function(){B.find(".invited").show()}})}}return false},edit:function(){this.$(".list-edit-modal").modal()},update:function(){this.$(".list-edit-modal").modal("hide");var z=this.$(".list-edit-modal form");var A=F.form2json(z);if(!("public" in A)){A["public"]=false}this.model.save(A);return false}});var t=Backbone.View.extend({el:"#lists",events:{"click .new-list-button":"show_add_form","submit .new-list-form":"add"},views:{},current_list:null,initialize:function(){var z=this;this.collection=new j();this.collection.bind("add",this.append_new_list,this);this.collection.bind("destroy",function(){this.resize_height(-26)},this);this.collection.bind("reset",this.render,this);this.collection.bind("reset",this.user_lists_loaded,this);this.collection.fetch();this.bookmarks=this.options.bookmarks;this.$(".lists-ul").sortable({revert:true,start:function(A,B){},stop:function(A,C){var D=$(C.item).data("id");var B=z.collection.get(D);B.save({position:C.item.index()})}})},render_current_list_view:function(z){this.current_list_view=z;this.current_list_view.render()},render:function(A,C,B){var z=this;if(!B){B="ul.lists-ul"}$.each(A.models,function(D,E){z.append_new_list(E,A,null,B)});if(!this.$(".jquery-bootstrap-pagination").html()){F.show_paginator(z,4,function(){})}this.$(".jquery-bootstrap-pagination").addClass("pagination-mini");this.resize_height()},resize_height:function(z){var B=$(".user-lists").height();var A=s-320;if(A<B){B=A}if(z){B+=z}$(".user-lists").css("height",B)},append_new_list:function(G,D,B,E){var H=$("#list-tmpl").html();var C=_.template(H,{lists:[G.toJSON()]});if(!E){E="ul.lists-ul"}var z=G.get("kind");if(z==0){E=".sys-lists .nav"}else{if(z==3){E=".shared-lists-ul"}else{this.$(".user-lists-sep").show()}}this.$(E+"-sep").show();E=this.$(E);E.append(C);E.show();var I=this;var A=new d({model:G,el:"#list-"+G.id});this.views[G.id]=A;A.bind("seleted",this.list_selected,this);A.bind("dropped",this.list_dropped,this);G.bind("destroy",this.render_all_list,this)},show_add_form:function(){$(".new-list-button").hide();$(".new-list-form").show();$(".new-list-form").find("input.list-name").focus()},list_dropped:function(D,z,C){if(typeof(D)!="number"){var B=this.current_list_view.model}else{var B=this.collection.get(D)}var A=B.bookmarks.get(z);A.save({list:C.url()})},list_selected:function(z){},add:function(C){var A=$(C.currentTarget);var B=F.form2json(A);B.user=USER_URL;this.collection.create(B,{wait:true});$(".new-list-button").show();$(".new-list-form").hide();A.find("input.list-name").val("");var z=28;if(this.collection.size()<=2){z=48}this.resize_height(z);return false}});$(document).ready(function(){o=new t();var z=new b({id:"all"});var A=new x({model:z,el:"#all-list",fake_list:true});var D=new b({id:"feed"});var C=new x({model:D,el:"#feed",fake_list:true});var B=0;var E=Backbone.Router.extend({routes:{"":"index",":username/list/all":"index",":username/list/feed":"feed",":username/list/:id":"list",":username/tag/:tag":"tag",":username/search/:query":"search"},index:function(G){$("body").animate({scrollTop:0});o.render_current_list_view(A)},feed:function(G){$("body").animate({scrollTop:0});o.render_current_list_view(C)},list:function(J,I){$("body").animate({scrollTop:0});var G=o.views[I];var H=I;if(G){G.render()}else{if(B<=8){setTimeout(function(){router.list(J,I)},400);B++}}},search:function(J,H){$("body").animate({scrollTop:0});var G=new b({id:"search",query:H,name:TEXTS.search_title+decodeURI(H)});var I=new c({model:G,el:"#no-such-dom",fake_list:true});o.render_current_list_view(I)},tag:function(J,G){$("body").animate({scrollTop:0});var H=new b({id:"tag",tag:G,name:TEXTS.tag_title+G});var I=new i({model:H,el:"#no-such-dom",fake_list:true});o.render_current_list_view(I)}});router=new E();s=$(window).height();$("#bookmarks").css("min-height",s);$("#lists").css("min-height",s);sidebarwidth=$(".sidebar-width").css("width");bodypaddingtop=$(".navbar-fixed-top").css("height");$(".sidebar-nav-fixed").css("width",sidebarwidth);contentmargin=parseInt(sidebarwidth);$(".span-fixed-sidebar").css("marginLeft",contentmargin);$(".span-fixed-sidebar").css("paddingLeft",60);Backbone.history.start({pushState:true})})}).call(this);