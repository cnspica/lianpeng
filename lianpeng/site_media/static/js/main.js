(function(){F={fetch_title:function(y,z){$.post("/harvest/pageinfo/",{url:y},z)},url_domain:function(z){var y=document.getElementById("url-template");y.href=z;var A=y.hostname;if(y.port&&y.port!=80){A+=":"+y.port}return A},form2json:function(z){var A={};var y=$(z).serializeArray();$.each(y,function(){if(A[this.name]!==undefined){if(!A[this.name].push){A[this.name]=[A[this.name]]}A[this.name].push(this.value||"")}else{A[this.name]=this.value||""}});return A},show_paginator:function(y,A,B){var z=y;if(z.collection.total_count>z.collection.paginationConfig.ipp){z.$(".paginator").pagination({total_pages:Math.ceil(z.collection.total_count/z.collection.paginationConfig.ipp),current_page:z.collection.currentPage,display_max:A,callback:function(C,D){B();z.collection.loadPage(D)}}).show()}else{z.$(".paginator").hide()}}};$.fn.spin=function(y){this.each(function(){var A=$(this),z=A.data();if(z.spinner){z.spinner.stop();delete z.spinner}if(y!==false){z.spinner=new Spinner($.extend({color:A.css("color")},y)).spin(this)}});return this};var p="/api/v1/user/"+USER_ID;var n=Backbone.Model.extend({urlRoot:"/api/v1/bookmark/"});var a=Backbone.Collection.extend({parse:function(y){this.total_count=y.meta.total_count;return y.objects}});var t=Backbone.Model.extend({urlRoot:"/api/v1/comment/"});var c=Backbone.Model.extend({urlRoot:"/api/v1/list/"});var l=c.extend({});var j=a.extend({model:c,initialize:function(){Backbone.Pagination.enable(this,{page_attr:"offset",ipp:100,ipp_attr:"limit"})},baseUrl:"/api/v1/list/"});var e=Backbone.View.extend({events:{"click .list-name":"redirect"},initialize:function(){var y=this;this.model.bind("destroy",this.delete_model,this);this.model.bind("change",this.change_name,this);this.$el.droppable({accept:".bookmark-entry-box",tolerance:"pointer",drop:_.bind(function(B,C){var A=$(B.target);var z=$(C.draggable).data("id");var D=$(C.draggable).data("list-id");y.trigger("dropped",D,z,y.model);$(C.draggable).remove()},this),over:_.bind(function(A,B){var z=$(A.target);if(z.hasClass("active")){z.addClass("source")}else{z.addClass("active")}},this),out:_.bind(function(A,B){var z=$(A.target);if(!z.hasClass("source")){z.removeClass("active")}},this)})},delete_model:function(){this.remove();$("#all-list .list-name").click()},redirect:function(){var y=USER_NAME+"/list/"+this.model.id;if(Backbone.history.fragment==y){Backbone.history.fragment=null}Backbone.history.navigate(y,true)},render:function(){var A=this.model;var z=$("#list-bookmarks-tmpl").html();var y=_.template(z,{list:A.toJSON()});$("#bookmarks").html(y);$("#bookmarks").spin();this.bookmarks=new o({list:this.model});this.bookmarks.bind("reset",this.stop_spin,this);this.model.bookmarks=this.bookmarks;this.bookmarks_view=new u({collection:this.bookmarks,el:"#bookmarks #list-bookmarks-"+this.model.id+" .bookmarks",list:this.model});this.bookmarks.fetch();this.list_setting_view=new h({el:"#bookmarks #list-bookmarks-"+this.model.id+" .list-header",model:this.model});$("#lists li").removeClass("active");this.$el.addClass("active")},stop_spin:function(){$("#bookmarks").spin(false)},change_name:function(){this.$(".list-name .name-text").text(this.model.get("name"))}});var x=e.extend({initialize:function(){}});var d=e.extend({render:function(){e.prototype.render.call(this);$(".add-bookmark-form-box").hide();$(".list-setting-box").hide()}});var k=d.extend({});var h=Backbone.View.extend({events:{"click .delete-list":"delete_list","click .list-edit-modal .save":"update","submit .list-edit-modal form":"update","click .edit-list":"edit"},change_name:function(){this.$(".list-name").text(this.model.get("name"))},initialize:function(){this.model.bind("change",this.change_name,this)},delete_list:function(){var y=confirm("确认删除？");if(y){this.model.destroy()}},edit:function(){this.$(".list-edit-modal").modal()},update:function(){this.$(".list-edit-modal").modal("hide");var y=this.$(".list-edit-modal form");var z=F.form2json(y);if(!("public" in z)){z["public"]=false}this.model.save(z);return false}});var s=Backbone.View.extend({el:"#lists",events:{"click .new-list-button":"show_add_form","submit .new-list-form":"add"},views:{},current_list:null,initialize:function(){var y=this;this.collection=new j();this.collection.bind("add",this.append_new_list,this);this.collection.bind("destroy",function(){this.resize_height(-26)},this);this.collection.bind("reset",this.render,this);this.collection.fetch();this.bookmarks=this.options.bookmarks;this.$(".lists-ul").sortable({revert:true,start:function(z,A){},stop:function(z,B){var C=$(B.item).data("id");var A=y.collection.get(C);A.save({position:B.item.index()})}})},render_current_list_view:function(y){this.current_list_view=y;this.current_list_view.render()},render:function(){var y=this;this.$("ul.lists-ul").html("");$.each(this.collection.models,function(z,A){y.append_new_list(A)});if(!this.$(".jquery-bootstrap-pagination").html()){F.show_paginator(y,4,function(){})}this.$(".jquery-bootstrap-pagination").addClass("pagination-mini");this.resize_height()},resize_height:function(y){var A=$(".user-lists").height();var z=r-320;if(z<A){A=z}if(y){A+=y}$(".user-lists").css("height",A)},append_new_list:function(C){var B=$("#list-tmpl").html();var z=_.template(B,{lists:[C.toJSON()]});var D=this.$("ul.lists-ul");var A=C.get("kind");if(A!=2){D=this.$(".sys-lists .nav")}D.append(z);var y=this;var E=new e({model:C,el:"#list-"+C.id});this.views[C.id]=E;E.bind("seleted",this.list_selected,this);E.bind("dropped",this.list_dropped,this);C.bind("destroy",this.render_all_list,this)},show_add_form:function(){$(".new-list-button").hide();$(".new-list-form").show();$(".new-list-form").find("input.list-name").focus()},list_dropped:function(C,y,B){if(typeof(C)!="number"){var A=this.current_list_view.model}else{var A=this.collection.get(C)}var z=A.bookmarks.get(y);z.save({list:B.url()})},list_selected:function(y){},add:function(A){var y=$(A.currentTarget);var z=F.form2json(y);z.user=p;this.collection.create(z,{wait:true});$(".new-list-button").show();$(".new-list-form").hide();y.find("input.list-name").val("");this.resize_height(28);return false}});var o=a.extend({model:n,list:null,initialize:function(y){if(y&&y.list){this.list=y.list}Backbone.Pagination.enable(this,{page_attr:"offset",ipp:20,ipp_attr:"limit"})},baseUrl:function(){if(this.list){if(typeof(this.list.id)=="number"){return this.list.url()+"/bookmarks/"}else{var y="";if(this.list.id=="search"){y="?q="+this.list.get("query")}else{if(this.list.id=="tag"){y="?tag="+this.list.get("tag")}else{if(this.list.id=="feed"){y="?feed=t"}}}return"/api/v1/bookmark/"+y}}else{return"/api/v1/bookmark/"}}});var g=Backbone.View.extend({initialize:function(){this.$el=$("#bookmark-"+this.model.id);this.events={"click .edit-action":"edit","click .share-action":"share","click .save-action":"collect","click .comment-box .publish":"comment","click .shares .douban":"share_douban",hover:"show_actions","hover .move":"enable_drag","mouseleave .move":"disable_drag","click .remove-action":"remove"};this.list=this.options.list;this.listenTo(this.model,"destroy",this.remove_bookmark_html);this.listenTo(this.model,"change",this.append_bookmark_html)},comment:function(){},collect:function(){this.trigger("new_bookmark",this.model.toJSON(),"","#bookmark-"+this.model.id+" .edit-bookmark-box")},share:function(y){$(y.currentTarget).dropdown("toggle")},share_douban:function(){var A=this.model.get("note");var E=this.model.get("title");var z=this.model.get("url");var D=document,C=encodeURIComponent,B="http://www.douban.com/recommend/?url="+C(z)+"&title="+C(E)+"&sel="+C(A)+"&v=1",y=function(){if(!window.open(B,"douban","toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330")){location.href=B+"&r=1"}};if(/Firefox/.test(navigator.userAgent)){setTimeout(y,0)}else{y()}},enable_drag:function(){this.$el.draggable({helper:"clone",});this.$el.draggable("enable")},disable_drag:function(){this.$el.draggable("disable")},show_actions:function(){this.$(".move").toggle();this.$(".actions").toggle()},remove_bookmark_html:function(){this.$el.remove()},remove:function(){this.model.destroy()},append_bookmark_html:function(A){var z=$("#bookmarks-tmpl").html();var A=this.model;var y=_.template(z,{bookmarks:[A.toJSON()],list:this.list});this.$el.html($(y).html())},edit:function(){var y=this;var A=$("#bookmark-form-tmpl").html();var z=_.template(A,{bookmark:y.model.toJSON(),list:this.list.toJSON()});this.$(".bookmark-title-box").hide();this.$(".edit-bookmark-box").html(z).show();y.$(".edit-bookmark-box form").submit(function(B){y.model.save(F.form2json(this));y.$(".bookmark-title-box").show();return false});y.$(".edit-bookmark-box form .cancel").click(function(){y.$(".edit-bookmark-box").hide();y.$(".bookmark-title-box").show()})}});var u=Backbone.View.extend({events:{"click .tag":"list_by_tag","submit .add-bookmark-form":"add_bookmark"},list_by_tag:function(z){var y=$(z.currentTarget).text();b.navigate(USER_NAME+"/tag/"+y,{trigger:true})},initialize:function(){var y=this;y.listenTo(y.collection,"add",function(z){y.create_bookmark_view(z,true)});y.listenTo(y.collection,"reset",y.create_bookmarks_views);this.list=this.options.list},create_bookmarks_views:function(A){var z=A.models;var y=this;y.render();y.render_pagination();$.each(z,function(B,C){y.create_bookmark_view(C)})},create_bookmark_view:function(z,y){if(y){this.append_bookmark_html(z)}var A=new g({model:z,list:this.list});this.listenTo(A,"new_bookmark",this.show_add_bookmark_form)},add_bookmark:function(A){var z=$(A.currentTarget).find(".url").val();$(A.currentTarget).spin();$(A.currentTarget).find("input").attr("disabled","on");var y=this;F.fetch_title(z,function(C){$(A.currentTarget).spin(false);C=$.parseJSON(C);if(C){var B=F.url_domain(z);C.url=z;C.domain=B;C.tags="";y.show_add_bookmark_form(C,A.currentTarget)}});return false},show_add_bookmark_form:function(B,A,D){var y={url:B.url,user:p,title:B.title,domain:B.domain,note:B.note,tags:B.tags};var z=B.url;var H=this;if(!D){D=".confirm-add-bookmark"}var G=$("#bookmark-form-tmpl").html();var C=_.template(G,{bookmark:y,list:this.list.toJSON()});H.$(D).html(C).show();H.$(D+" .existed-bookmark .spinner").spin({length:0,radius:6,width:2});var E=new o();E.bind("reset",function(J){H.$(D+" .existed-bookmark .spinner").spin(false);if(J.total_count>0){var I=J.models[0];H.$(D+" .existed-bookmark").addClass("alert");H.$(D+" .existed-bookmark .text").show();H.$(D+" .existed-bookmark .edit").click(function(){if(!H.collection.get(I.id)){H.collection.push(I)}H.$(D+" .existed-bookmark .edit").attr("href","#bookmark-"+I.id);H.$(".list #bookmark-"+I.id+" .bookmark-title-box .actions .edit-action").trigger("click");H.recover_submit_form(D,A)})}else{H.$(D+" .existed-bookmark").hide()}});E.fetch({url:E.url()+"&url="+z});H.$(D+" form").submit(function(){var I=F.form2json(this);if(typeof(list_id)=="number"){I.list=H.list.url()}H.collection.create(I,{wait:true,success:function(J){}});H.recover_submit_form(D,A);return false});H.$(D+" form .cancel").click(function(){H.recover_submit_form(D,A)})},recover_submit_form:function(z,y){$(z).hide();$(y).find("input").removeAttr("disabled");$(y).find("input.url").val("")},append_bookmark_html:function(A){if(this.list.id=="feed"){return false}var z=$("#bookmarks-tmpl").html();var y=_.template(z,{bookmarks:[A.toJSON()],list:this.list.toJSON()});this.$(".no-bookmarks").hide();this.$(".list").prepend(y)},render_pagination:function(){if(!this.$(".jquery-bootstrap-pagination").html()){var y=this;F.show_paginator(y,8,function(){$(y.$(".list").children()[0]).spin()})}},render:function(){var y=this;if(this.collection.size()>0){var A=$("#bookmarks-tmpl").html();var z=_.template(A,{bookmarks:this.collection.toJSON(),list:y.list.toJSON()});this.$(".list").html(z)}else{this.$(".list .no-bookmarks").show()}}});var m=new s();var i=new c({id:"all"});var v=new x({model:i,el:"#all-list",fake_list:true});var f=new c({id:"feed"});var w=new x({model:f,el:"#feed",fake_list:true});var q=Backbone.Router.extend({routes:{"":"index",":username/list/all":"index",":username/list/feed":"feed",":username/list/:id":"list",":username/tag/:tag":"tag",":username/search/:query":"search"},index:function(y){m.render_current_list_view(v)},feed:function(y){m.render_current_list_view(w)},list:function(C,B){var z=m.views[B];var A=B;if(z){z.render()}else{var y=new c({id:A});var z=new e({model:y});y.bind("change",function(D){z.render()});y.fetch()}},search:function(B,z){var y=new c({id:"search",query:z,name:TEXTS.search_title+z});var A=new d({model:y,el:"#no-such-dom",fake_list:true});m.render_current_list_view(A)},tag:function(B,y){var z=new c({id:"tag",tag:y,name:TEXTS.tag_title+y});var A=new k({model:z,el:"#no-such-dom",fake_list:true});m.render_current_list_view(A)}});var b=new q();var r=$(window).height();$("#bookmarks").css("min-height",r);$("#lists").css("min-height",r);sidebarwidth=$(".sidebar-width").css("width");bodypaddingtop=$(".navbar-fixed-top").css("height");$(".sidebar-nav-fixed").css("width",sidebarwidth);contentmargin=parseInt(sidebarwidth);$(".span-fixed-sidebar").css("marginLeft",contentmargin);$(".span-fixed-sidebar").css("paddingLeft",60);Backbone.history.start({pushState:true})}).call(this);